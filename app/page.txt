"use client";
import React, { useState } from 'react';
import { useCart } from './hooks/useCart';
import { SignInButton, SignedIn, SignedOut, UserButton } from '@clerk/nextjs';
import { Menu, X, UserCircle, Search } from 'lucide-react';

const PRODUCTS = [
  // --- TEQUE√ëOS ---
  { id: 'f-teq-q', nombre: 'Teque√±os Queso (8cm) - Fresco', categoria: 'Teque√±os', precio_menudeo: 302, precio_mayoreo: 281 },
  { id: 'f-teq-qg', nombre: 'Teque√±os Queso con Guayaba (8cm)', categoria: 'Teque√±os', precio_menudeo: 372, precio_mayoreo: 346 },
  // --- EMPANADAS ---
  { id: 'f-emp-q', nombre: 'Empanada Queso - Fresca', categoria: 'Empanadas', precio_menudeo: 446, precio_mayoreo: 415 },
  { id: 'f-emp-pq', nombre: 'Empanada Pastor con Queso - Fresca', categoria: 'Empanadas', precio_menudeo: 512, precio_mayoreo: 476 },
  // --- MINI ---
  { id: 'f-mini-q', nombre: 'Mini Empanada Queso - Fresca', categoria: 'Mini Empanadas', precio_menudeo: 465, precio_mayoreo: 432 },
  // --- MASAS ---
  { id: 'm-piz', nombre: 'Masa Pizza (1kg)', categoria: 'Masas', precio_menudeo: 60, precio_mayoreo: 45 },
];

const SHIPPING_ZONES = {
  local: { label: 'Toluca y zona metropolitana', price: 120 },
  centro: { label: 'Centro del pa√≠s', price: 190 },
  nacional: { label: 'Resto de la Rep√∫blica Mexicana', price: 260 },
};

export default function Home() {
  const { cart, addToCart, getCartSubtotal } = useCart();
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeCategory, setActiveCategory] = useState("Todos");
  const [searchTerm, setSearchTerm] = useState("");

  const categories = ["Todos", "Teque√±os", "Empanadas", "Mini Empanadas", "Masas"];
  
  const filteredProducts = PRODUCTS.filter(p => {
    const matchesSearch = p.nombre.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesCategory = activeCategory === "Todos" || p.categoria === activeCategory;
    return matchesSearch && matchesCategory;
  });

  const subtotal = getCartSubtotal();
  const shippingZone = 'local'; // Simplificado para el ejemplo
  const total = subtotal + SHIPPING_ZONES[shippingZone].price;

  return (
    <main className="min-h-screen bg-gray-50 pb-40">
      {/* HEADER PRINCIPAL */}
      <header className="p-4 bg-white shadow-sm sticky top-0 z-[60] flex justify-between items-center">
        <button 
          onClick={() => setIsMenuOpen(true)}
          className="bg-[#15803d] p-3 rounded-xl text-white shadow-lg active:scale-95 transition"
        >
          <Menu size={24} strokeWidth={3} />
        </button>
        
        <h1 className="font-black text-2xl tracking-tighter italic">CRUMAFOOD</h1>
        
        <div className="bg-black text-white px-4 py-2 rounded-full text-xs font-black tracking-widest">
          üõí {cart.length}
        </div>
      </header>

      {/* BUSCADOR R√ÅPIDO */}
      <div className="p-4 bg-white border-b">
        <div className="relative">
          <Search className="absolute left-4 top-3 text-gray-400" size={18} />
          <input 
            type="text" 
            placeholder="¬øQu√© se te antoja hoy?" 
            className="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl text-sm font-bold outline-none"
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      </div>

      {/* --- MEN√ö LATERAL ESTILO WINGSTOP --- */}
      <div className={`fixed inset-0 z-[100] transition-opacity duration-300 ${isMenuOpen ? "opacity-100 pointer-events-auto" : "opacity-0 pointer-events-none"}`}>
        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)} />
        
        <aside className={`absolute inset-y-0 left-0 w-80 bg-white shadow-2xl p-8 flex flex-col transform transition-transform duration-300 ${isMenuOpen ? "translate-x-0" : "-translate-x-full"}`}>
          <button onClick={() => setIsMenuOpen(false)} className="absolute top-6 right-6 text-gray-400 hover:text-black transition">
            <X size={32} />
          </button>

          {/* PERFIL / INICIAR SESI√ìN */}
          <div className="mt-10 border-b pb-8 mb-8">
            <SignedOut>
              <SignInButton mode="modal">
                <button className="flex items-center gap-4 group">
                  <div className="bg-gray-100 p-3 rounded-full group-hover:bg-gray-200 transition">
                    <UserCircle size={32} className="text-gray-400" />
                  </div>
                  <span className="font-black text-xl uppercase tracking-tighter">Iniciar Sesi√≥n</span>
                </button>
              </SignInButton>
            </SignedOut>
            <SignedIn>
              <div className="flex items-center gap-4">
                <UserButton afterSignOutUrl="/" appearance={{elements: {userButtonAvatarBox: "w-12 h-12 shadow-md"}}} />
                <span className="font-black text-xl uppercase tracking-tighter">Mi Cuenta</span>
              </div>
            </SignedIn>
          </div>

          {/* MEN√ö DE CATEGOR√çAS */}
          <nav className="flex flex-col gap-6">
            <p className="text-[10px] font-black text-gray-300 uppercase tracking-[0.2em]">Men√∫</p>
            {categories.map(cat => (
              <button
                key={cat}
                onClick={() => { setActiveCategory(cat); setIsMenuOpen(false); }}
                className={`text-left font-black text-2xl uppercase tracking-tighter transition-all ${
                  activeCategory === cat ? "text-[#15803d] translate-x-2" : "text-gray-900 hover:translate-x-2"
                }`}
              >
                {cat}
              </button>
            ))}
          </nav>

          <div className="mt-auto space-y-4 pt-10 border-t">
            <p className="text-[#15803d] font-bold text-sm uppercase">Sobre Nosotros</p>
            <p className="text-gray-400 font-bold text-sm uppercase">T√©rminos y Condiciones</p>
          </div>
        </aside>
      </div>

      {/* GRILLA DE PRODUCTOS */}
      <div className="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
        {filteredProducts.map(p => (
          <div key={p.id} className="bg-white p-5 rounded-3xl border border-gray-100 shadow-sm hover:shadow-md transition">
            <span className="text-[10px] font-black text-[#15803d] uppercase tracking-widest">{p.categoria}</span>
            <h3 className="font-black text-gray-800 text-lg leading-tight mt-1 mb-4">{p.nombre}</h3>
            <div className="flex justify-between items-center">
              <p className="font-black text-2xl text-black tracking-tighter">${p.precio_mayoreo} <span className="text-[10px] text-gray-400">MXN</span></p>
              <button 
                onClick={() => addToCart(p)} 
                className="bg-[#15803d] text-white px-6 py-2 rounded-2xl text-xs font-black shadow-lg shadow-green-100 active:scale-95 transition"
              >
                AGREGAR
              </button>
            </div>
          </div>
        ))}
      </div>

      {/* CARRITO FLOTANTE */}
      {cart.length > 0 && (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-6 shadow-[0_-20px_50px_rgba(0,0,0,0.15)] rounded-t-[40px] max-w-xl mx-auto z-50">
          <div className="flex justify-between items-end mb-6">
            <div>
              <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Total a pagar</p>
              <p className="font-black text-3xl text-black tracking-tighter">${total} MXN</p>
            </div>
            <div className="text-right">
              <p className="text-xs font-bold text-gray-400 italic">{cart.length} productos</p>
            </div>
          </div>

          <SignedIn>
            <button className="w-full bg-black text-white py-5 rounded-[24px] font-black text-xl shadow-xl active:scale-95 transition uppercase tracking-tight">Continuar al Pago</button>
          </SignedIn>
          <SignedOut>
            <SignInButton mode="modal">
              <button className="w-full bg-[#15803d] text-white py-5 rounded-[24px] font-black text-xl shadow-xl active:scale-95 transition uppercase tracking-tight">Inicia sesi√≥n para pagar</button>
            </SignInButton>
          </SignedOut>
        </div>
      )}
    </main>
  );
}